<!DOCTYPE html>
<html>
  <head>
    <title>Redirecting to Naver Form...</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YE02J0GZFP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YE02J0GZFP');
    </script>
  </head>
  <body>
    <p>SuperfastSAT 상담예약 페이지로 이동 중입니다.</p>
    <script>
      // [알림 스위치] false로 설정하면 슬랙 알림이 가지 않습니다. (다시 켜려면 true로 변경)
      const SEND_SLACK = false; 

      const params = new URLSearchParams(window.location.search);
      const src = params.get('src') || 'unknown';

      // 2. 구글 앱스 스크립트 주소 (유지)
      const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxT5fH5Ty-J_VRpQPx62zgqR-NYZFCrxn9c_ocah8ppTJa8EF5tFCj1fBv43Hl1NLa5uw/exec";

      // 3. 네이버 폼 링크 매핑
      const formLinks = {
        writerM: "https://naver.me/5vcNQM5k",
        writerB: "https://naver.me/xoHZaLjZ",
        writerW: "https://naver.me/G1mAHDDo",
        summer: "https://naver.me/Ixs28oOn",
        writerH: "https://naver.me/502RrpMr"
      };

      let formLink = "https://naver.me/defaultForm";

      if (src.includes("writerM")) formLink = formLinks.writerM;
      else if (src.includes("writerB")) formLink = formLinks.writerB;
      else if (src.includes("writerW")) formLink = formLinks.writerW;   
      else if (src.includes("summer")) formLink = formLinks.summer;
      else if (src.includes("writerH")) formLink = formLinks.writerH;

      // -----------------------------------------------------------
      // [최종 병기] 봇/중복 차단 필터
      // -----------------------------------------------------------
      function shouldSendAlert(src) {
        const ua = navigator.userAgent.toLowerCase();
        
        // 1. [기본 차단] 봇 키워드 + Headless 감지
        if (/bot|crawler|spider|crawling|facebook|kakaotalk|twitter|slack|whatsapp|telegram|naver|headless|lighthouse|google-inspectiontool/.test(ua)) {
            return false;
        }

        // 2. [강력 차단] WebDriver(자동화 도구) 감지
        if (navigator.webdriver) {
            return false;
        }

        // 3. [유령 브라우저 차단]
        if (!window.screen || window.screen.width === 0 || window.screen.height === 0 || document.visibilityState === 'hidden') {
            return false;
        }

        // 4. [중복 방지] 기억력(LocalStorage) 체크 (10분 쿨타임)
        const storageKey = 'slack_alert_naver_' + src; 
        const lastSent = localStorage.getItem(storageKey);
        const now = new Date().getTime();

        if (lastSent && (now - lastSent < 600000)) { 
            return false;
        }

        localStorage.setItem(storageKey, now);
        return true;
      }

      // 검사 실행
      const isRealUser = shouldSendAlert(src);

      // 4. GA 이벤트 전송 (항상 실행됨)
      gtag('event', 'naver_form_submit', {
        event_category: 'BlogToNaverForm',
        event_label: src
      });

      // 5. 슬랙 전송 (스위치가 켜져 있고 & 사람일 때만 실행)
      if (SEND_SLACK && isRealUser) {
          // 0.5초 딜레이
          setTimeout(() => {
            fetch(GOOGLE_SCRIPT_URL, {
              method: "POST",
              mode: "no-cors",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                  src: src, 
                  type: 'naver_form' 
              }),
            }).catch(err => console.log("Slack Alert Error:", err));
          }, 500);
      } else {
          console.log("Slack alert is disabled or skipped.");
      }

      // 6. 리디렉션 (3초 후 이동 - 항상 실행됨)
      setTimeout(() => {
        window.location.href = formLink;
      }, 3000);
    </script>
  </body>
</html>
